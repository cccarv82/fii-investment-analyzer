import React, { createContext, useContext, useState, useEffect } from "react";

// üéØ Contexto da IA com prompts de n√≠vel MUNDIAL
const AIContext = createContext();

// ü§ñ Classe para gerenciar IA da OpenAI com estrat√©gias de investimento de elite
class OpenAIManager {
  constructor() {
    this.apiKey = null;
    this.baseURL = "https://api.openai.com/v1";
    this.model = "gpt-4"; // Usando GPT-4 para m√°xima qualidade
  }

  setApiKey(key) {
    this.apiKey = key;
    if (key) {
      localStorage.setItem("fii_analyzer_openai_key", key);
    } else {
      localStorage.removeItem("fii_analyzer_openai_key");
    }
  }

  getApiKey() {
    if (!this.apiKey) {
      this.apiKey = localStorage.getItem("fii_analyzer_openai_key");
    }
    return this.apiKey;
  }

  // üöÄ Fazer requisi√ß√£o para OpenAI com tratamento robusto
  async makeRequest(messages, temperature = 0.3) {
    if (!this.getApiKey()) {
      throw new Error("API key da OpenAI n√£o configurada");
    }

    const response = await fetch(`${this.baseURL}/chat/completions`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${this.getApiKey()}`,
      },
      body: JSON.stringify({
        model: this.model,
        messages: messages,
        temperature: temperature,
        max_tokens: 4000, // Aumentado para an√°lises mais detalhadas
        top_p: 0.9,
        frequency_penalty: 0.1,
        presence_penalty: 0.1,
      }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(
        `OpenAI API Error: ${error.error?.message || "Erro desconhecido"}`
      );
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  // üéØ PROMPT MASTER: An√°lise fundamentalista de FII individual
  async analyzeFII(fiiData, userProfile) {
    const messages = [
      {
        role: "system",
        content: `Voc√™ √© Warren Buffett especializado em Fundos de Investimento Imobili√°rio do Brasil.

EXPERTISE: Combine as metodologias de Benjamin Graham (an√°lise fundamentalista), Modern Portfolio Theory (Markowitz), e estrat√©gias espec√≠ficas do mercado brasileiro de FIIs.

CONTEXTO BRASILEIRO: Considere cen√°rio econ√¥mico atual, taxa Selic, infla√ß√£o, mercado imobili√°rio brasileiro, regulamenta√ß√£o CVM, e caracter√≠sticas √∫nicas dos FIIs brasileiros.

METODOLOGIA DE AN√ÅLISE:

1. AN√ÅLISE QUANTITATIVA:
   - P/VP (ideal: 0.80-1.20 para FIIs de tijolo, at√© 1.50 para receb√≠veis)
   - Dividend Yield (m√≠nimo 6% para competir com Selic)
   - Consist√™ncia de distribui√ß√µes (√∫ltimos 24 meses)
   - Liquidez (volume m√©dio di√°rio)
   - Crescimento patrimonial (√∫ltimos 5 anos)

2. AN√ÅLISE QUALITATIVA:
   - Qualidade dos ativos (localiza√ß√£o, idade, inquilinos)
   - Gest√£o (track record, transpar√™ncia, estrat√©gia)
   - Setor (tend√™ncias, ciclo econ√¥mico, demanda futura)
   - Governan√ßa corporativa
   - Estrutura de capital

3. AN√ÅLISE SETORIAL:
   - Log√≠stica: E-commerce, nearshoring, infraestrutura
   - Shoppings: Recupera√ß√£o p√≥s-pandemia, omnichannel
   - Corporativo: Trabalho h√≠brido, ESG, certifica√ß√µes
   - Receb√≠veis: Spread banc√°rio, inadimpl√™ncia, duration
   - Residencial: Demografia, financiamento habitacional

4. AN√ÅLISE MACROECON√îMICA:
   - Impacto da Selic nas valuations
   - Infla√ß√£o vs. reajustes contratuais
   - Crescimento do PIB vs. demanda por im√≥veis
   - Pol√≠tica fiscal e tribut√°ria

RETORNE AN√ÅLISE EM JSON ESTRUTURADO com campos obrigat√≥rios.`,
      },
      {
        role: "user",
        content: `Analise este FII com rigor de Warren Buffett:

DADOS DO FII:
- Nome: ${fiiData.name}
- Ticker: ${fiiData.ticker}
- Pre√ßo: R$ ${fiiData.price}
- Dividend Yield: ${fiiData.dividendYield}%
- P/VP: ${fiiData.pvp}
- Setor: ${fiiData.sector}
- Market Cap: R$ ${fiiData.marketCap?.toLocaleString() || "N/A"}
- Volume M√©dio: ${fiiData.volume?.toLocaleString() || "N/A"}

PERFIL DO INVESTIDOR:
- Perfil de Risco: ${userProfile.riskProfile}
- Objetivo: ${userProfile.investmentGoal}
- Prazo: ${userProfile.timeHorizon}

RETORNE JSON com esta estrutura EXATA:
{
  "score": n√∫mero de 0 a 10,
  "recommendation": "COMPRAR" | "MANTER" | "VENDER" | "EVITAR",
  "reasoning": "an√°lise detalhada de 200-300 palavras",
  "strengths": ["ponto forte 1", "ponto forte 2", "ponto forte 3"],
  "weaknesses": ["ponto fraco 1", "ponto fraco 2"],
  "targetPrice": pre√ßo-alvo em reais,
  "riskLevel": "BAIXO" | "M√âDIO" | "ALTO",
  "suitability": n√∫mero de 0 a 10 para o perfil do investidor,
  "fundamentalAnalysis": {
    "valuation": "an√°lise de valuation",
    "quality": "qualidade dos ativos",
    "management": "an√°lise da gest√£o",
    "sector": "perspectivas do setor"
  }
}`,
      },
    ];

    const response = await this.makeRequest(messages, 0.3);
    return JSON.parse(response);
  }

  // üéØ PROMPT MASTER: An√°lise de carteira completa
  async analyzePortfolio(portfolio, userProfile) {
    const messages = [
      {
        role: "system",
        content: `Voc√™ √© Ray Dalio especializado em carteiras de FIIs brasileiros.

EXPERTISE: Combine princ√≠pios de All Weather Portfolio, Risk Parity, e Modern Portfolio Theory adaptados para FIIs brasileiros.

METODOLOGIA DE AN√ÅLISE DE CARTEIRA:

1. DIVERSIFICA√á√ÉO:
   - Setorial (m√°ximo 40% em um setor)
   - Geogr√°fica (diferentes regi√µes do Brasil)
   - Por gestora (m√°ximo 30% em uma gestora)
   - Por tipo de ativo (tijolo vs. receb√≠veis)

2. CORRELA√á√ÉO E RISCO:
   - Correla√ß√£o entre setores
   - Beta vs. IFIX
   - Volatilidade hist√≥rica
   - Value at Risk (VaR)
   - Maximum Drawdown

3. EFICI√äNCIA DE CAPITAL:
   - Sharpe Ratio ajustado para FIIs
   - Sortino Ratio
   - Information Ratio
   - Treynor Ratio

4. AN√ÅLISE DE FLUXO:
   - Previsibilidade de dividendos
   - Sazonalidade setorial
   - Ciclo de renova√ß√£o de contratos
   - Crescimento org√¢nico vs. aquisi√ß√µes

5. CEN√ÅRIOS MACROECON√îMICOS:
   - Stress test com Selic 15%
   - Cen√°rio recess√£o
   - Cen√°rio infla√ß√£o alta
   - Cen√°rio crescimento acelerado

RETORNE AN√ÅLISE COMPLETA EM JSON.`,
      },
      {
        role: "user",
        content: `Analise esta carteira de FIIs com rigor de Ray Dalio:

CARTEIRA ATUAL:
${portfolio
  .map(
    (p) => `- ${p.ticker}: ${p.shares} cotas, R$ ${p.totalInvested} investido`
  )
  .join("\n")}

PERFIL DO INVESTIDOR:
- Perfil de Risco: ${userProfile.riskProfile}
- Objetivo: ${userProfile.investmentGoal}

RETORNE JSON com esta estrutura:
{
  "overallScore": n√∫mero de 0 a 10,
  "diversificationScore": n√∫mero de 0 a 10,
  "riskScore": n√∫mero de 0 a 10,
  "recommendations": ["recomenda√ß√£o 1", "recomenda√ß√£o 2"],
  "strengths": ["for√ßa 1", "for√ßa 2"],
  "weaknesses": ["fraqueza 1", "fraqueza 2"],
  "suggestedActions": ["a√ß√£o 1", "a√ß√£o 2"],
  "riskAnalysis": {
    "concentration": "an√°lise de concentra√ß√£o",
    "correlation": "an√°lise de correla√ß√£o",
    "volatility": "an√°lise de volatilidade"
  }
}`,
      },
    ];

    const response = await this.makeRequest(messages, 0.3);
    return JSON.parse(response);
  }

  // üéØ PROMPT MASTER: Gera√ß√£o de carteira otimizada
  async generateInvestmentSuggestions(params) {
    const { amount, riskProfile, investmentGoal, timeHorizon, availableFiis } =
      params;

    const messages = [
      {
        role: "system",
        content: `Voc√™ √© Harry Markowitz + Warren Buffett criando a carteira PERFEITA de FIIs brasileiros.

MISS√ÉO: Criar carteira otimizada que maximize retorno ajustado ao risco usando Modern Portfolio Theory + Value Investing.

PRINC√çPIOS FUNDAMENTAIS:

1. DIVERSIFICA√á√ÉO INTELIGENTE:
   - M√°ximo 20% em qualquer FII individual
   - M√°ximo 35% em qualquer setor
   - M√≠nimo 5 FIIs diferentes (para valores acima de R$ 1.000)
   - Correla√ß√£o baixa entre ativos

2. CRIT√âRIOS DE SELE√á√ÉO (Buffett Style):
   - P/VP atrativo (preferencialmente < 1.0)
   - Dividend Yield sustent√°vel (6-12%)
   - Hist√≥rico consistente de distribui√ß√µes
   - Qualidade dos ativos subjacentes
   - Gest√£o competente e transparente

3. ALOCA√á√ÉO POR PERFIL:

CONSERVADOR:
- 40% Log√≠stica (estabilidade)
- 25% Corporativo AAA (inquilinos s√≥lidos)
- 20% Receb√≠veis baixo risco
- 15% Shoppings regionais

MODERADO:
- 35% Log√≠stica
- 25% Corporativo
- 25% Receb√≠veis
- 15% Shoppings/H√≠bridos

ARROJADO:
- 30% Log√≠stica
- 20% Corporativo
- 30% Receb√≠veis alto yield
- 20% Setores emergentes

4. OTIMIZA√á√ÉO MATEM√ÅTICA:
   - Minimizar vari√¢ncia para dado retorno esperado
   - Maximizar Sharpe Ratio
   - Considerar custos de transa√ß√£o
   - Rebalanceamento trimestral

RETORNE CARTEIRA OTIMIZADA EM JSON.`,
      },
      {
        role: "user",
        content: `Crie carteira PERFEITA com estes par√¢metros:

VALOR DISPON√çVEL: R$ ${amount.toLocaleString()}
PERFIL DE RISCO: ${riskProfile}
OBJETIVO: ${investmentGoal}
PRAZO: ${timeHorizon}

FIIs DISPON√çVEIS:
${availableFiis
  .map(
    (fii) =>
      `- ${fii.ticker} (${fii.name}): R$ ${fii.price} | DY: ${fii.dividendYield}% | P/VP: ${fii.pvp} | Setor: ${fii.sector}`
  )
  .join("\n")}

CRIT√âRIOS OBRIGAT√ìRIOS:
- Use 90%+ do valor dispon√≠vel
- M√°ximo 20% em qualquer FII
- M√≠nimo 3 FIIs diferentes
- Diversifica√ß√£o setorial

RETORNE JSON com esta estrutura EXATA:
{
  "suggestions": [
    {
      "ticker": "c√≥digo do FII",
      "name": "nome do FII",
      "shares": n√∫mero de cotas,
      "investmentAmount": valor em reais,
      "percentage": porcentagem do total,
      "reasoning": "justificativa da escolha",
      "expectedYield": dividend yield esperado,
      "riskLevel": "BAIXO" | "M√âDIO" | "ALTO",
      "sector": "setor do FII"
    }
  ],
  "totalInvested": valor total investido,
  "totalShares": total de cotas,
  "averageYield": dividend yield m√©dio,
  "diversificationScore": nota de 0 a 10,
  "riskScore": nota de 0 a 10,
  "strategy": "explica√ß√£o da estrat√©gia utilizada",
  "expectedReturn": retorno esperado anual,
  "portfolioAnalysis": {
    "strengths": ["for√ßa 1", "for√ßa 2"],
    "risks": ["risco 1", "risco 2"],
    "sectorAllocation": {"setor": "porcentagem"}
  }
}`,
      },
    ];

    const response = await this.makeRequest(messages, 0.7);
    return JSON.parse(response);
  }

  // üéØ PROMPT MASTER: An√°lise de mercado
  async generateMarketAnalysis(marketData) {
    const messages = [
      {
        role: "system",
        content: `Voc√™ √© um especialista em mercado de FIIs brasileiro com 20 anos de experi√™ncia.

EXPERTISE: An√°lise macro e setorial do mercado de FIIs, tend√™ncias, oportunidades e riscos.

METODOLOGIA:
1. An√°lise macroecon√¥mica (Selic, infla√ß√£o, PIB)
2. An√°lise setorial (log√≠stica, shoppings, corporativo, etc.)
3. Fluxo de investimentos
4. Valuations relativos
5. Oportunidades e riscos

RETORNE AN√ÅLISE COMPLETA EM JSON.`,
      },
      {
        role: "user",
        content: `Analise o mercado atual de FIIs brasileiro:

DADOS DE MERCADO:
${JSON.stringify(marketData, null, 2)}

RETORNE JSON com esta estrutura:
{
  "marketOverview": "vis√£o geral do mercado",
  "trends": ["tend√™ncia 1", "tend√™ncia 2"],
  "opportunities": ["oportunidade 1", "oportunidade 2"],
  "risks": ["risco 1", "risco 2"],
  "sectorAnalysis": {
    "logistica": "an√°lise do setor",
    "shoppings": "an√°lise do setor",
    "corporativo": "an√°lise do setor"
  },
  "recommendation": "recomenda√ß√£o geral"
}`,
      },
    ];

    const response = await this.makeRequest(messages, 0.5);
    return JSON.parse(response);
  }
}

// üéØ Provider do contexto de IA
export function AIProvider({ children }) {
  const [aiManager] = useState(() => new OpenAIManager());
  const [isConfigured, setIsConfigured] = useState(false);

  useEffect(() => {
    // Verificar se API key est√° configurada
    const apiKey = aiManager.getApiKey();
    setIsConfigured(!!apiKey);
  }, [aiManager]);

  // üîß Configurar API key
  const setApiKey = (key) => {
    aiManager.setApiKey(key);
    setIsConfigured(!!key);
  };

  // üóëÔ∏è Remover API key
  const removeApiKey = () => {
    aiManager.setApiKey(null);
    setIsConfigured(false);
  };

  // üîç Obter API key (mascarada para exibi√ß√£o)
  const getApiKey = () => {
    return aiManager.getApiKey();
  };

  // ü§ñ Gerar sugest√µes de investimento
  const generateInvestmentSuggestions = async (params) => {
    if (!isConfigured) {
      throw new Error("IA n√£o configurada. Configure sua API key da OpenAI.");
    }
    return await aiManager.generateInvestmentSuggestions(params);
  };

  // üìä Analisar FII individual
  const analyzeFII = async (fiiData, userProfile) => {
    if (!isConfigured) {
      throw new Error("IA n√£o configurada. Configure sua API key da OpenAI.");
    }
    return await aiManager.analyzeFII(fiiData, userProfile);
  };

  // üìà Analisar carteira
  const analyzePortfolio = async (portfolio, userProfile) => {
    if (!isConfigured) {
      throw new Error("IA n√£o configurada. Configure sua API key da OpenAI.");
    }
    return await aiManager.analyzePortfolio(portfolio, userProfile);
  };

  // üìä Gerar an√°lise de mercado
  const generateMarketAnalysis = async (marketData) => {
    if (!isConfigured) {
      throw new Error("IA n√£o configurada. Configure sua API key da OpenAI.");
    }
    return await aiManager.generateMarketAnalysis(marketData);
  };

  const value = {
    isConfigured,
    setApiKey,
    removeApiKey,
    getApiKey,
    generateInvestmentSuggestions,
    analyzeFII,
    analyzePortfolio,
    generateMarketAnalysis,
  };

  return <AIContext.Provider value={value}>{children}</AIContext.Provider>;
}

// üéØ Hook para usar o contexto de IA
export const useAI = () => {
  const context = useContext(AIContext);
  if (!context) {
    throw new Error("useAI deve ser usado dentro de um AIProvider");
  }
  return context;
};

export default AIContext;
